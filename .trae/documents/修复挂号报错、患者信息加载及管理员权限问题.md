# 修复计划

针对您提出的四个问题，我将执行以下修复步骤：

## 1. 修复挂号缴费 500 错误
**问题原因**：后端 `OPDController` 接收挂号请求时缺乏异常处理，如果数据校验失败或数据库插入异常（如外键问题）会直接抛出 500 错误。
**修复方案**：
- 修改 `backend/src/main/java/com/hospital/controller/OPDController.java`，在 `createOPD` 方法中添加 `try-catch` 块，捕获异常并返回具体的错误信息（如“挂号失败：参数错误”），而不是通用的 500 错误。

## 2. 修复患者信息显示与 ID 提取问题
**问题原因**：
- 前端 `Register.vue` 和 `MyCenter.vue` 仍然使用旧逻辑（从用户名中正则提取数字）来获取 `patientId`。对于新注册的用户名（如 "zhangsan"），提取结果为空或 NaN，导致无法获取患者信息。
- `MyCenter.vue` 因此显示“未绑定病历号”。
**修复方案**：
- 修改 `frontend/src/views/Register.vue`，彻底移除 `username.replace` 逻辑，改为调用 `patientApi.getMe()`（对应后端 `/patients/me`）直接获取当前登录用户的患者信息。
- 确保 `frontend/src/views/MyCenter.vue` 也使用相同的 `getMe()` 逻辑，确保能正确加载已绑定的患者信息。

## 3. 修复管理员权限问题
**问题原因**：`SecurityConfig` 配置可能限制了管理员访问候诊列表数据的接口（如 `/opds/waiting` 或 `/doctors` 相关接口可能仅限医生访问）。
**修复方案**：
- 修改 `backend/src/main/java/com/hospital/config/SecurityConfig.java`，确保 `ADMIN` 角色拥有访问所有 `/opds/**` 和 `/doctors/**` 接口的权限，以便管理员查看候诊列表。

## 4. 验证与构建
- 重新构建前端 (`npm run build`) 和后端 (`mvn package`) 以应用更改。
